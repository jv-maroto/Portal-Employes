# Docker Compose para integraci√≥n local con nginx existente
# Este archivo es para tu VM local, no se sube a GitHub
version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.simple
    container_name: portal-empleados-backend
    ports:
      - "8001:8000"  # Puerto diferente para no interferir con otros servicios
    volumes:
      - ./backend/media:/app/media
      - portal_db:/app/db.sqlite3
    environment:
      # Configuraci√≥n para producci√≥n local
      - DEBUG=False
      - SECRET_KEY=local-secret-key-change-this-in-production-2024
      - ALLOWED_HOSTS=sagreracanarias.es,www.sagreracanarias.es,localhost,127.0.0.1,backend
      - CORS_ALLOWED_ORIGINS=https://sagreracanarias.es,http://sagreracanarias.es,https://www.sagreracanarias.es
      - CORS_ALLOW_ALL_ORIGINS=False
      # Configuraci√≥n de email (usa las credenciales reales)
      - EMAIL_HOST=smtp.dominioabsoluto.net
      - EMAIL_PORT=587
      - EMAIL_USE_TLS=True
      - EMAIL_HOST_USER=info@sagreracanarias.es
      - EMAIL_HOST_PASSWORD=Sagrer4.c4narias
      - DEFAULT_FROM_EMAIL=noreply@sagreracanarias.es
      # Configuraci√≥n de URL base
      - FORCE_SCRIPT_NAME=/trabajadores
      - STATIC_URL=/trabajadores/static/
      - MEDIA_URL=/trabajadores/media/
    networks:
      - portal-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "manage.py", "check"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    image: nginx:alpine
    container_name: portal-empleados-frontend
    ports:
      - "3001:80"  # Puerto diferente para el frontend
    command: >
      sh -c "
      echo '<!DOCTYPE html>
      <html lang=\"es\">
      <head>
          <meta charset=\"UTF-8\">
          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
          <title>Portal Empleados - Sagrera Canarias</title>
          <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
              .container { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); max-width: 600px; width: 90%; text-align: center; }
              h1 { color: #2c3e50; margin-bottom: 1rem; font-size: 2rem; }
              .logo { width: 80px; height: 80px; background: #3498db; border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 2rem; }
              .status { background: #d4edda; color: #155724; padding: 1rem; border-radius: 10px; margin: 1rem 0; border: 1px solid #c3e6cb; }
              .links { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0; }
              .link { display: block; padding: 1rem; background: #3498db; color: white; text-decoration: none; border-radius: 10px; transition: all 0.3s ease; font-weight: 500; }
              .link:hover { background: #2980b9; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4); }
              .info { background: #f8f9fa; padding: 1rem; border-radius: 10px; margin: 1rem 0; text-align: left; }
              .info h3 { color: #495057; margin-bottom: 0.5rem; }
              .info p { color: #6c757d; margin: 0.25rem 0; }
              .emoji { font-size: 1.2em; margin-right: 0.5rem; }
              .footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #dee2e6; color: #6c757d; font-size: 0.9rem; }
          </style>
      </head>
      <body>
          <div class=\"container\">
              <div class=\"logo\">üè¢</div>
              <h1>Portal Empleados</h1>
              <p style=\"color: #6c757d; margin-bottom: 1rem;\">Sagrera Canarias</p>
              
              <div class=\"status\">
                  <strong><span class=\"emoji\">‚úÖ</span>Sistema funcionando correctamente</strong>
              </div>
              
              <div class=\"links\">
                  <a href=\"/trabajadores/admin/\" class=\"link\">
                      <span class=\"emoji\">üîß</span>Panel de Administraci√≥n
                  </a>
                  <a href=\"/trabajadores/api/\" class=\"link\">
                      <span class=\"emoji\">üì°</span>API Backend
                  </a>
              </div>
              
              <div class=\"info\">
                  <h3><span class=\"emoji\">üåê</span>URLs de Acceso</h3>
                  <p><strong>Portal:</strong> https://sagreracanarias.es/trabajadores/</p>
                  <p><strong>Admin:</strong> https://sagreracanarias.es/trabajadores/admin/</p>
                  <p><strong>API:</strong> https://sagreracanarias.es/trabajadores/api/</p>
              </div>
              
              <div class=\"info\">
                  <h3><span class=\"emoji\">üìã</span>Estado del Sistema</h3>
                  <p>‚úÖ Backend Django operativo (Puerto 8001)</p>
                  <p>‚úÖ Frontend Nginx operativo (Puerto 3001)</p>
                  <p>‚úÖ Base de datos configurada</p>
                  <p>‚úÖ API REST disponible</p>
                  <p>‚úÖ Integraci√≥n con nginx principal activa</p>
              </div>
              
              <div class=\"footer\">
                  <p>Portal Empleados v1.0 - Sagrera Canarias</p>
                  <p>Configurado para trabajar en: /trabajadores</p>
              </div>
          </div>
      </body>
      </html>' > /usr/share/nginx/html/index.html &&
      echo 'server {
          listen 80;
          root /usr/share/nginx/html;
          index index.html;
          
          location / {
              try_files \$$uri \$$uri/ /index.html;
              add_header Cache-Control \"no-cache, no-store, must-revalidate\";
          }
      }' > /etc/nginx/conf.d/default.conf &&
      nginx -g 'daemon off;'
      "
    depends_on:
      - backend
    networks:
      - portal-network
    restart: unless-stopped

  # Opcional: Base de datos PostgreSQL para producci√≥n
  postgres:
    image: postgres:13
    container_name: portal-empleados-db
    environment:
      - POSTGRES_DB=portal_empleados_prod
      - POSTGRES_USER=portal_admin
      - POSTGRES_PASSWORD=portal_password_secure_2024
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"  # Puerto diferente para no interferir
    networks:
      - portal-network
    restart: unless-stopped

volumes:
  portal_db:
  postgres_data:

networks:
  portal-network:
    driver: bridge
    name: portal-empleados-net